{% stylesheets
    '@KdigMediaBundle/Resources/public/css/jquery.fileupload-ui.css'
%} <link href="{{ asset_url }}" type="text/css" rel="stylesheet" media="screen" /> {% endstylesheets %}

{% javascripts
    '@KdigMediaBundle/Resources/public/js/jquery.iframe-transport.js'
    '@KdigMediaBundle/Resources/public/js/jquery.ui.widget.js'
    '@KdigMediaBundle/Resources/public/js/jquery.fileupload.js'
%} <script type="text/javascript" src="{{ asset_url }}"></script> {% endjavascripts %}

<input id="fileupload" type="file" name="files[]" data-url="{{ oneup_uploader_endpoint('gallery') }}" multiple />

<script type="text/javascript">
    $(document).ready(function() {
        $('#fileupload').fileupload();
        $('#fileupload').bind('fileuploadsend', function (e, data) {
            if (data.dataType.substr(0, 6) === 'iframe') {
                var progressObj = {
                    name: '{{ oneup_uploader_upload_key() }}',
                    value: (new Date()).getTime() // pseudo unique ID
                };

                data.formData.push(progressObj);
                data.context.data('interval', setInterval(function () {
                    $.get('{{ oneup_uploader_progress("gallery") }}', $.param([progressObj]), function (result) {
                        e = $.Event( 'progress', {bubbles: false, cancelable: true});
                        $.extend(e, result);
                        ($('#fileupload').data('blueimp-fileupload') ||
                            $('#fileupload').data('fileupload'))._onProgress(e, data);
                    }, 'json');
                }, 1000));
            }
        }).bind('fileuploadalways', function (e, data) {
            clearInterval(data.context.data('interval'));
        });
    });
</script>